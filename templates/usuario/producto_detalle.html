{% extends 'base.html' %}

{% block title %}{{ producto.nombre }} - StyleYoung{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'tienda:home' %}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'tienda:productos' %}">Productos</a></li>
            <li class="breadcrumb-item"><a href="{% url 'tienda:productos' %}?categoria={{ producto.categoria.id }}">{{ producto.categoria.nombre }}</a></li>
            <li class="breadcrumb-item active">{{ producto.nombre }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Imagen del producto -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                {% if producto.imagen_principal %}
                    <img src="{{ producto.imagen_principal.url }}" 
                         alt="{{ producto.nombre }}" 
                         class="card-img-top" 
                         style="height: 500px; object-fit: cover;">
                {% elif producto.imagenes.first %}
                    <img src="{{ producto.imagenes.first.imagen.url }}" 
                         alt="{{ producto.nombre }}" 
                         class="card-img-top" 
                         style="height: 500px; object-fit: cover;">
                {% else %}
                    <div class="card-body text-center py-5">
                        <i class="bi bi-image display-1 text-muted"></i>
                        <p class="text-muted mt-3">Imagen no disponible</p>
                        <small class="text-muted">{{ producto.nombre }}</small>
                    </div>
                {% endif %}
                
                <!-- Galería de imágenes adicionales -->
                {% if producto.imagenes.all %}
                    <div class="card-body">
                        <div class="row">
                            {% for imagen in producto.imagenes.all %}
                                <div class="col-3 mb-2">
                                    <img src="{{ imagen.imagen.url }}" 
                                         alt="{{ imagen.descripcion|default:producto.nombre }}" 
                                         class="img-thumbnail" 
                                         style="height: 80px; object-fit: cover; cursor: pointer;"
                                         onclick="cambiarImagenPrincipal('{{ imagen.imagen.url }}')">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Detalles del producto -->
        <div class="col-lg-6">
            <div class="mb-3">
                <span class="badge bg-primary fs-6">{{ producto.categoria.nombre }}</span>
            </div>
            
            <h1 class="display-5 fw-bold">{{ producto.nombre }}</h1>
            <h2 class="text-muted mb-3">{{ producto.marca }}</h2>
            
            <div class="mb-4">
                <span class="h2 text-primary">${{ producto.precio }}</span>
            </div>
            
            <!-- Información adicional -->
            <div class="row mb-4">
                <div class="col-md-4 mb-2">
                    <strong>Color:</strong><br>
                    <span class="badge bg-secondary">{{ producto.color }}</span>
                </div>
                <div class="col-md-4 mb-2">
                    <strong>Material:</strong><br>
                    <span class="badge bg-info">{{ producto.material }}</span>
                </div>
                <div class="col-md-4 mb-2">
                    <strong>Stock Total:</strong><br>
                    <span class="badge {% if producto.stock_total > 5 %}bg-success{% elif producto.stock_total > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                        {{ producto.stock_total }} unidades
                    </span>
                </div>
            </div>
            
            <!-- Descripción -->
            <div class="mb-4">
                <h5>Descripción</h5>
                <p class="text-muted">{{ producto.descripcion }}</p>
            </div>
            
            <!-- Selector de Tallas con Stock en Tiempo Real -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Selecciona tu Talla</h5>
                    <div id="stock-info" class="text-muted small" style="display: none;">
                        <i class="bi bi-box-seam"></i> <span id="stock-cantidad">0</span> disponibles
                    </div>
                </div>
                
                {% if producto.tallas.all %}
                <div class="tallas-selector mb-3">
                    {% for talla in producto.tallas.all %}
                    <button type="button" 
                            class="btn-talla {% if talla.stock > 0 %}disponible{% else %}agotada{% endif %} {% if talla.stock > 0 and talla.stock <= 3 %}pocas-unidades{% endif %}" 
                            data-talla-id="{{ talla.id }}" 
                            data-talla-nombre="{{ talla.talla }}" 
                            data-stock="{{ talla.stock }}"
                            {% if talla.stock == 0 %}disabled{% endif %}>
                        <span class="talla-texto">{{ talla.talla }}</span>
                        <small class="stock-texto">
                            {% if talla.stock > 5 %}
                                Disponible
                            {% elif talla.stock > 0 %}
                                {{ talla.stock }} left
                            {% else %}
                                Agotado
                            {% endif %}
                        </small>
                    </button>
                    {% endfor %}
                </div>
                
                <div id="talla-seleccionada" style="display: none;">
                    <div class="alert alert-info">
                        <i class="bi bi-check-circle"></i> 
                        Talla <strong id="talla-elegida">-</strong> seleccionada
                        <span id="stock-detalle"></span>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    No hay tallas disponibles en este momento.
                </div>
                {% endif %}
            </div>
            
            <!-- Formulario de Compra -->
            {% if user.is_authenticated %}
                {% if producto.stock_total > 0 %}
                <form method="post" action="{% url 'tienda:agregar_al_carrito' producto.id %}" class="mb-3" id="form-agregar-carrito">
                    {% csrf_token %}
                    <input type="hidden" name="talla_id" id="talla-id-hidden" value="">
                    
                    <div class="row align-items-end">
                        <div class="col-md-6 mb-2">
                            <label for="cantidad" class="form-label">Cantidad</label>
                            <div class="input-group">
                                <button type="button" class="btn btn-outline-secondary" id="btn-decrease">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <input type="number" class="form-control text-center" name="cantidad" id="cantidad" 
                                       value="1" min="1" max="1" readonly>
                                <button type="button" class="btn btn-outline-secondary" id="btn-increase">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            <small id="cantidad-ayuda" class="form-text text-muted">Selecciona una talla primero</small>
                        </div>
                        <div class="col-md-6 mb-2">
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="btn-agregar" disabled>
                                <i class="bi bi-cart-plus"></i> Agregar al Carrito
                            </button>
                        </div>
                    </div>
                </form>
                {% else %}
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> 
                    Producto completamente agotado. No se puede agregar al carrito.
                </div>
                {% endif %}
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> 
                <a href="{% url 'auth:login' %}">Inicia sesión</a> para agregar productos al carrito.
            </div>
            {% endif %}
            
            <!-- Botones adicionales -->
            <div class="d-flex gap-2 mt-3">
                <a href="{% url 'tienda:productos' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver a Productos
                </a>
                {% if user.is_authenticated %}
                <a href="{% url 'tienda:carrito' %}" class="btn btn-outline-primary">
                    <i class="bi bi-cart"></i> Ver Carrito
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Productos relacionados -->
    <div class="row mt-5">
        <div class="col-12">
            <h3>Productos Similares</h3>
            <p class="text-muted">Otros productos de la categoría {{ producto.categoria.nombre }}</p>
            <div class="text-center py-4">
                <a href="{% url 'tienda:productos' %}?categoria={{ producto.categoria.id }}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-right"></i> Ver Más de {{ producto.categoria.nombre }}
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.tallas-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.btn-talla {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 80px;
    height: 80px;
    border: 2px solid #ddd;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 8px;
}

.btn-talla.disponible {
    border-color: #28a745;
    color: #28a745;
}

.btn-talla.disponible:hover {
    background-color: #28a745;
    color: white;
    transform: translateY(-2px);
}

.btn-talla.pocas-unidades {
    border-color: #ffc107;
    color: #ffc107;
    position: relative;
}

.btn-talla.pocas-unidades::after {
    content: '⚠️';
    position: absolute;
    top: -5px;
    right: -5px;
    font-size: 12px;
}

.btn-talla.agotada {
    border-color: #dc3545;
    color: #dc3545;
    background-color: #f8f9fa;
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-talla.seleccionada {
    background-color: #007bff !important;
    color: white !important;
    border-color: #007bff !important;
}

.talla-texto {
    font-weight: bold;
    font-size: 16px;
    line-height: 1;
}

.stock-texto {
    font-size: 10px;
    line-height: 1;
    margin-top: 2px;
}

.quantity-controls {
    user-select: none;
}

@media (max-width: 768px) {
    .btn-talla {
        width: 70px;
        height: 70px;
    }
    
    .tallas-selector {
        gap: 8px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let tallaSeleccionada = null;
let stockActual = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Manejar selección de tallas - con verificaciones de existencia
    const botonesTallas = document.querySelectorAll('.btn-talla:not([disabled])');
    const tallaHidden = document.getElementById('talla-id-hidden');
    const cantidadInput = document.getElementById('cantidad');
    const btnAgregar = document.getElementById('btn-agregar');
    const btnDecrease = document.getElementById('btn-decrease');
    const btnIncrease = document.getElementById('btn-increase');
    const stockInfo = document.getElementById('stock-info');
    const stockCantidad = document.getElementById('stock-cantidad');
    const tallaSeleccionadaDiv = document.getElementById('talla-seleccionada');
    const tallaElegida = document.getElementById('talla-elegida');
    const stockDetalle = document.getElementById('stock-detalle');
    const cantidadAyuda = document.getElementById('cantidad-ayuda');
    
    // Verificar que los elementos existen antes de usarlos
    if (!tallaHidden || !cantidadInput || !btnAgregar) {
        console.log('Algunos elementos del formulario no están presentes');
        return;
    }

    botonesTallas.forEach(boton => {
        boton.addEventListener('click', function() {
            // Remover selección anterior
            botonesTallas.forEach(b => b.classList.remove('seleccionada'));
            
            // Seleccionar nueva talla
            this.classList.add('seleccionada');
            
            // Obtener datos
            tallaSeleccionada = this.dataset.tallaId;
            stockActual = parseInt(this.dataset.stock);
            const tallaNombre = this.dataset.tallaNombre;
            
            // Actualizar campos ocultos y mostrar info
            tallaHidden.value = tallaSeleccionada;
            stockCantidad.textContent = stockActual;
            stockInfo.style.display = 'block';
            
            // Mostrar talla seleccionada
            tallaElegida.textContent = tallaNombre;
            if (stockActual <= 3) {
                stockDetalle.innerHTML = ` - <span class="text-warning">¡Solo ${stockActual} disponibles!</span>`;
            } else {
                stockDetalle.innerHTML = ` - <span class="text-success">${stockActual} disponibles</span>`;
            }
            tallaSeleccionadaDiv.style.display = 'block';
            
            // Actualizar cantidad máxima
            cantidadInput.max = stockActual;
            cantidadInput.value = 1;
            cantidadInput.disabled = false;
            
            // Habilitar botón agregar
            btnAgregar.disabled = false;
            
            // Actualizar ayuda
            cantidadAyuda.textContent = `Máximo ${stockActual} unidades disponibles`;
            cantidadAyuda.className = stockActual <= 3 ? 'form-text text-warning' : 'form-text text-success';
            
            // Habilitar controles de cantidad
            actualizarControlesCantidad();
        });
    });

    // Controles de cantidad
    btnDecrease.addEventListener('click', function() {
        const cantidad = parseInt(cantidadInput.value);
        if (cantidad > 1) {
            cantidadInput.value = cantidad - 1;
            actualizarControlesCantidad();
        }
    });

    btnIncrease.addEventListener('click', function() {
        const cantidad = parseInt(cantidadInput.value);
        if (cantidad < stockActual) {
            cantidadInput.value = cantidad + 1;
            actualizarControlesCantidad();
        }
    });

    cantidadInput.addEventListener('input', function() {
        const cantidad = parseInt(this.value);
        if (cantidad < 1) this.value = 1;
        if (cantidad > stockActual) this.value = stockActual;
        actualizarControlesCantidad();
    });

    function actualizarControlesCantidad() {
        const cantidad = parseInt(cantidadInput.value);
        
        // Habilitar/deshabilitar botones
        btnDecrease.disabled = cantidad <= 1;
        btnIncrease.disabled = cantidad >= stockActual;
        
        // Actualizar texto del botón agregar
        if (cantidad > 1) {
            btnAgregar.innerHTML = `<i class="bi bi-cart-plus"></i> Agregar ${cantidad} al Carrito`;
        } else {
            btnAgregar.innerHTML = `<i class="bi bi-cart-plus"></i> Agregar al Carrito`;
        }
        
        // Actualizar info de stock restante
        const stockRestante = stockActual - cantidad;
        if (stockRestante === 0) {
            cantidadAyuda.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> Tomarías todo el stock disponible</span>`;
        } else if (stockRestante <= 2) {
            cantidadAyuda.innerHTML = `<span class="text-warning">Quedarían ${stockRestante} unidades</span>`;
        } else {
            cantidadAyuda.textContent = `Quedarían ${stockRestante} unidades disponibles`;
        }
    }

    // Validación del formulario
    document.getElementById('form-agregar-carrito').addEventListener('submit', function(e) {
        if (!tallaSeleccionada) {
            e.preventDefault();
            alert('Por favor selecciona una talla antes de agregar al carrito.');
            return false;
        }
        
        const cantidad = parseInt(cantidadInput.value);
        if (cantidad < 1 || cantidad > stockActual) {
            e.preventDefault();
            alert(`La cantidad debe estar entre 1 y ${stockActual}.`);
            return false;
        }
        
        // Mostrar confirmación
        const tallaNombre = document.querySelector('.btn-talla.seleccionada').dataset.tallaNombre;
        if (confirm(`¿Agregar ${cantidad} unidad${cantidad > 1 ? 'es' : ''} de talla ${tallaNombre} al carrito?`)) {
            // Aquí el formulario se enviaría normalmente
            btnAgregar.disabled = true;
            btnAgregar.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Agregando...';
        } else {
            e.preventDefault();
        }
    });
    
    // Función para cambiar imagen principal
    window.cambiarImagenPrincipal = function(nuevaUrl) {
        const imagenPrincipal = document.querySelector('.card-img-top');
        if (imagenPrincipal && imagenPrincipal.tagName === 'IMG') {
            imagenPrincipal.src = nuevaUrl;
        }
    };
});
</script>
{% endblock %}