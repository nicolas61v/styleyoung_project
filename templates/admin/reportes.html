{% extends 'admin/base_admin.html' %}

{% block page_title %}Reportes y Análisis{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <a href="{% url 'tienda:descargar_reporte_pdf' %}" class="btn btn-danger btn-sm" target="_blank">
        <i class="bi bi-file-pdf"></i> Descargar PDF
    </a>
    <a href="{% url 'tienda:descargar_reporte_excel' %}" class="btn btn-success btn-sm" target="_blank">
        <i class="bi bi-file-excel"></i> Descargar Excel
    </a>
    <button class="btn btn-outline-info btn-sm" onclick="actualizarDatos()">
        <i class="bi bi-arrow-clockwise"></i> Actualizar
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Métricas Principales -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>${{ ventas_mes|floatformat:0 }}</h4>
                        <p class="mb-0">Ventas del Mes</p>
                    </div>
                    <div>
                        <i class="bi bi-cash-coin fa-2x"></i>
                    </div>
                </div>
                <small>Pedidos entregados este mes</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ pedidos_completados_mes }}</h4>
                        <p class="mb-0">Pedidos Completados</p>
                    </div>
                    <div>
                        <i class="bi bi-bag-check fa-2x"></i>
                    </div>
                </div>
                <small>Este mes</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ total_vendidos }}</h4>
                        <p class="mb-0">Productos Vendidos</p>
                    </div>
                    <div>
                        <i class="bi bi-box-seam fa-2x"></i>
                    </div>
                </div>
                <small>Total histórico</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ productos_count }}</h4>
                        <p class="mb-0">Productos Activos</p>
                    </div>
                    <div>
                        <i class="bi bi-box2"></i>
                    </div>
                </div>
                <small>En catálogo</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Top 3 Productos Más Vendidos -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-trophy"></i> Top Productos Más Vendidos</h5>
            </div>
            <div class="card-body">
                {% if top_productos %}
                    {% for producto in top_productos|slice:":3" %}
                    <div class="row mb-3">
                        <div class="col-2">
                            <div class="bg-{% if forloop.counter == 1 %}warning{% elif forloop.counter == 2 %}secondary{% else %}info{% endif %} text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="bi bi-{% if forloop.counter == 1 %}trophy{% elif forloop.counter == 2 %}award{% else %}star{% endif %}"></i>
                            </div>
                        </div>
                        <div class="col-8">
                            <h6 class="mb-1">{{ producto.nombre }}</h6>
                            <small class="text-muted">Categoría: {{ producto.categoria.nombre }}</small>
                        </div>
                        <div class="col-2 text-end">
                            <strong>{{ producto.total_vendidos }}</strong><br>
                            <small class="text-muted">vendidos</small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">Sin productos vendidos aún</p>
                    </div>
                {% endif %}

                <div class="text-center mt-3">
                    <a href="{% url 'tienda:admin_productos' %}" class="btn btn-outline-primary btn-sm">
                        Ver Todos los Productos
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ventas por Categoría -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-pie-chart"></i> Ventas por Categoría</h5>
            </div>
            <div class="card-body">
                {% if ventas_por_categoria %}
                    {% for categoria in ventas_por_categoria %}
                        {% if categoria.total_vendidos > 0 %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>{{ categoria.nombre }}</span>
                                <span>{{ categoria.porcentaje }}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" style="width: {{ categoria.porcentaje }}%"></div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">Sin datos de ventas por categoría</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Análisis de Stock -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-boxes"></i> Análisis de Inventario</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Producto</th>
                                <th>Categoría</th>
                                <th>Stock Total</th>
                                <th>Vendidos</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if productos %}
                                {% for producto in productos|slice:":5" %}
                                <tr>
                                    <td>
                                        <strong>{{ producto.nombre }}</strong><br>
                                        <small class="text-muted">ID: {{ producto.id }}</small>
                                    </td>
                                    <td><span class="badge bg-primary">{{ producto.categoria.nombre }}</span></td>
                                    <td>{{ producto.stock_total }}</td>
                                    <td>{{ producto.total_vendidos }}</td>
                                    <td>
                                        {% if producto.stock_total > 5 %}
                                            <span class="badge bg-success">Bueno</span>
                                        {% elif producto.stock_total > 0 %}
                                            <span class="badge bg-warning">Stock Bajo</span>
                                        {% else %}
                                            <span class="badge bg-danger">Agotado</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">Sin productos</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Estadísticas Rápidas -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-speedometer2"></i> Estadísticas Rápidas</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Productos activos:</span>
                    <strong class="text-success">{{ productos_count }}</strong>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Productos sin stock:</span>
                    <strong class="text-danger">{{ productos_sin_stock }}</strong>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Valor total inventario:</span>
                    <strong class="text-primary">${{ valor_inventario|floatformat:0 }}</strong>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Ticket promedio:</span>
                    <strong class="text-info">${{ ticket_promedio|floatformat:2 }}</strong>
                </div>

                <hr>

                <h6>Acciones Recomendadas:</h6>
                <ul class="list-unstyled">
                    {% if productos_sin_stock > 0 %}
                    <li><i class="bi bi-exclamation-triangle text-warning me-1"></i> <small>{{ productos_sin_stock }} producto{{ productos_sin_stock|pluralize }} sin stock</small></li>
                    {% endif %}
                    {% if top_productos %}
                    <li><i class="bi bi-plus-circle text-success me-1"></i> <small>Promocionar productos top</small></li>
                    {% endif %}
                    <li><i class="bi bi-graph-up text-info me-1"></i> <small>Analizar tendencias de venta</small></li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function exportarReporte() {
    alert('Función exportar reporte - Por implementar');
}

function actualizarDatos() {
    alert('Actualizando datos...');
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function actualizarContadoresVentas() {
    const button = event.target.closest('button');
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Calculando...';
    
    fetch('/api/actualizar-ventas/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`✅ ${data.message}`);
            location.reload();
        } else {
            alert('❌ Error al actualizar contadores');
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Actualizar';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Error de conexión');
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Actualizar';
    });
}
</script>
{% endblock %}